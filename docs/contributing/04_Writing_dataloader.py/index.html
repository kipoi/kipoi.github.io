<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>dataloader.py - Kipoi documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "dataloader.py";
    var mkdocs_page_input_path = "contributing/04_Writing_dataloader.py.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Kipoi documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Using</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/python/">Python</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/cli/">CLI</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/R/">R</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/plugins/">Plugins</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/03_Model_sources/">Private and public model sources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../using/04_Installing_on_OSX/">Installing on OSX</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Contributing</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../01_Getting_started/">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../02_Writing_model.yaml/">model.yaml</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">dataloader.py</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#dataloader-types">Dataloader types</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dataset-example">Dataset example</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#required-static-files">Required static files</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#further-examples">Further examples</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../03_Writing_dataloader.yaml/">dataloader.yaml</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../05_Writing_model.py/">model.py</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../06_dumping_models_programatically/">Multiple very similar models</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/contributing_models/">Contributing models</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/python-api/">Python API</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/R-api/">R API</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/tf_binding_models/">Comparing models</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../tutorials/composing_models/">Composing models</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../faq/">FAQ</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Api</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/list_/">list</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/install_/">install</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/model/">Model</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/dataloader/">Dataloader</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/pipeline/">Pipeline</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/sources/">sources</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/metadata/">metadata</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/readers/">readers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../api/writers/">writers</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Kipoi documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Contributing &raquo;</li>
        
      
    
    <li>dataloader.py</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="http://github.com/kipoi/kipoi/edit/master/docs/contributing/04_Writing_dataloader.py.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h2 id="dataloader">Dataloader</h2>
<aside class="warning">
Before writing a dataloader yourself please check whether the same functionality can be achieved using a ready-made 
dataloader in [kipoiseq](https://github.com/kipoi/kipoiseq).
</aside>

<p>The main aim of a dataloader is to generate batches of data with which a model can be run. It therefore has to return a dictionary with three keys:</p>
<ul>
<li><code>inputs</code></li>
<li><code>targets</code> (optional)</li>
<li><code>metadata</code> (optional).</li>
</ul>
<p>As the names suggest, the <code>inputs</code> will get feeded to the model to make the predictions and <code>targets</code> could be used to train the model. The <code>metadata</code> field is used to give additional information about the samples (like sample ID, or genomic ranges for DNA-sequence based models).</p>
<p>In a batch of data returned by the dataloader, all three fields can be further nested - i.e. <code>inputs</code> can be a list of numpy arrays or a dictionary of numpy arrays. The only restriction is that the leaf objects are numpy arrays and that the first axis (batch dimension) is the same for all arrays.</p>
<p>Note that the <code>inputs</code> and <code>targets</code> have to be compatible with the model you are using. Keras, for instance, can accept as inputs and targets all three options: single numpy array, list of numpy arrays, dictionary of numpy arrays (note: to use as input a dictionary of numpy arrays you have to use the functional API and specify the <code>name</code> fields in the <code>keras.layers.Input</code> layer). On the other hand, the Scikit-learn models only allow the inputs and targets to be a single 2-dimensional numpy array.</p>
<p>Conceptionally, there are three ways how you can write a dataloader. The dataloader can either yield:</p>
<ul>
<li>individual samples</li>
<li>batches of data</li>
<li>whole dataset</li>
</ul>
<p>Note that when a dataloader returns individual samples, the returned numpy arrays shouldn't contain the batch axis. The batch axis will get generated by Kipoi when batching the samples. Also, the samples may contain non-numpy array scalar types like <code>bool</code>, <code>float</code>, <code>int</code>, <code>str</code>. These will later get stacked into a one-dimensional numpy array.</p>
<h3 id="dataloader-types">Dataloader types</h3>
<p>Specifically, a dataloader has to inherit from one of the following classes defined in <code>kipoi.data</code>:</p>
<ul>
<li>
<p><code>PreloadedDataset</code> </p>
<ul>
<li>Function that returns the whole dataset as a nested dictionary/list of numpy arrays</li>
<li><strong>useful when:</strong> the dataset is expected to load quickly and fit into the memory</li>
</ul>
</li>
<li>
<p><code>Dataset</code> </p>
<ul>
<li>Class that inherits from <code>kipoi.data.Dataset</code> and implements <code>__len__</code> and <code>__getitem__</code> methods. <code>__getitem__</code> returns a single sample from the dataset.</li>
<li><strong>useful when:</strong> dataset length is easy to infer, there are no significant performance gain when reading data of the disk in batches</li>
</ul>
</li>
<li>
<p><code>BatchDataset</code> </p>
<ul>
<li>Class that inherits from <code>kipoi.data.BatchDataset</code> and implements <code>__len__</code> and  <code>__getitem__</code> methods. <code>__getitem__</code> returns a single batch of samples from the dataset.</li>
<li><strong>useful when:</strong> dataset length is easy to infer, and there is a significant performance gain when reading data of the disk in batches</li>
</ul>
</li>
<li>
<p><code>SampleIterator</code> </p>
<ul>
<li>Class that inherits from <code>kipoi.data.SampleIterator</code> and implements <code>__iter__</code> and <code>__next__</code> (<code>next</code> in python 2). <code>__next__</code> returns a single sample from the dataset or raises <code>StopIteration</code> if all the samples were already returned.</li>
<li><strong>useful when:</strong> the dataset length is not know in advance or is difficult to infer, and there are no significant performance gain when reading data of the disk in batches</li>
</ul>
</li>
<li>
<p><code>BatchIterator</code> </p>
<ul>
<li>Class that inherits from <code>kipoi.data.BatchIterator</code> and implements <code>__iter__</code> and <code>__next__</code> (<code>next</code> in python 2). <code>__next__</code> returns a single batch of samples sample from the dataset or raises <code>StopIteration</code> if all the samples were already returned.</li>
<li><strong>useful when:</strong> the dataset length is not know in advance or is difficult to infer, and there is a significant performance gain when reading data of the disk in batches</li>
</ul>
</li>
<li>
<p><code>SampleGenerator</code> </p>
<ul>
<li>A generator function that yields a single sample from the dataset and returns when all the samples were yielded.</li>
<li><strong>useful when:</strong> same as for <code>SampleIterator</code>, but can be typically implemented in fewer lines of code</li>
</ul>
</li>
<li>
<p><code>BatchGenerator</code> </p>
<ul>
<li>A generator function that yields a single batch of samples from the dataset and returns when all the samples were yielded.</li>
<li><strong>useful when:</strong> same as for <code>BatchIterator</code>, but can be typically implemented in fewer lines of code</li>
</ul>
</li>
</ul>
<p>Here is a table showing the (recommended) requirements for each dataloader type:</p>
<table>
<thead>
<tr>
<th>Dataloader type</th>
<th>Length known?</th>
<th>Significant benefit from loading data in batches?</th>
<th>Fits into memory and loads quickly?</th>
</tr>
</thead>
<tbody>
<tr>
<td>PreloadedDataset</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>Dataset</td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td>BatchDataset</td>
<td>yes</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>SampleIterator</td>
<td>no</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td>BatchIterator</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
<tr>
<td>SampleGenerator</td>
<td>no</td>
<td>no</td>
<td>no</td>
</tr>
<tr>
<td>BatchGenerator</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
</tbody>
</table>
<h3 id="dataset-example">Dataset example</h3>
<p>Here is an example dataloader that gets as input a <a href="http://genetics.bwh.harvard.edu/pph/FASTA.html">fasta</a> file and a <a href="https://genome.ucsc.edu/FAQ/FAQformat.html#format1">bed</a> file and returns a one-hot encoded sequence (under 'inputs') along with the used genomic interval (under 'metadata/ranges').</p>
<pre><code class="language-python">from __future__ import absolute_import, division, print_function
import numpy as np
from pybedtools import BedTool
from kipoi.data import Dataset
from kipoi.metadata import GenomicRanges

class SeqDataset(Dataset):
    &quot;&quot;&quot;
    Args:
        intervals_file: bed3 file containing intervals
        fasta_file: file path; Genome sequence
    &quot;&quot;&quot;

    def __init__(self, intervals_file, fasta_file):

        self.bt = BedTool(intervals_file)
        self.fasta_file = fasta_file
        self.fasta_extractor = None

    def __len__(self):
        return len(self.bt)

    def __getitem__(self, idx):
        if self.fasta_extractor is None:
            self.fasta_extractor = FastaExtractor(self.fasta_file)

        interval = self.bt[idx]

        seq = np.squeeze(self.fasta_extractor([interval]), axis=0)
        return {
            &quot;inputs&quot;: seq,
            # lacks targets
            &quot;metadata&quot;: {
                &quot;ranges&quot;: GenomicRanges.from_interval(interval)
            }
        }
</code></pre>
<p>Since <code>FastaExtractor</code> is not multi-processing safe, we have initialized it on the first call of <code>__getitem__</code> instead of <code>__init__</code>. The reason for this is that when we use parallel dataloading, each process will get a copy of the <code>SeqDataset(...)</code> object. Upon the first call of <code>__getitem__</code> the <code>fasta_extractor</code> and hence the underlying file-handle will be setup for each worker independently.</p>
<h3 id="required-static-files">Required static files</h3>
<p>If your dataloader requires an external data file as for example in 
<a href="../tutorials/contributing_models.html">tutorials/contributing_models</a>, then the Kipoi way of automatically downloading 
and using that file is by adding an argument to the dataloader implementation:</p>
<pre><code class="language-python">from __future__ import absolute_import, division, print_function
from kipoi.data import Dataset

class SeqDataset(Dataset):
    &quot;&quot;&quot;
    Args:
        intervals_file: bed3 file containing intervals
        fasta_file: file path; Genome sequence
    &quot;&quot;&quot;

    def __init__(self, intervals_file, fasta_file, essential_other_file):
        fh = open(essential_other_file, &quot;r&quot;)
        ...
</code></pre>
<p>Kipoi can automaticall download the required file from a zenodo or figshare url as if the url was defined as a default
 in the <code>dataloader.yaml</code> as follows:</p>
<pre><code class="language-yaml">args:
   ...
   essential_other_file:
       default:
           url: https://zenodo.org/path/to/my/essential/other/file.xyz
           md5: 765sadf876a
</code></pre>
<h3 id="further-examples">Further examples</h3>
<p>To see examples of other dataloaders, run <code>kipoi init</code> from the command-line and choose each time a different dataloader_type.</p>
<pre><code>$ kipoi init
INFO [kipoi.cli.main] Initializing a new Kipoi model

...

Select dataloader_type:
1 - Dataset
2 - PreloadedDataset
3 - BatchDataset
4 - SampleIterator
5 - SampleGenerator
6 - BatchIterator
7 - BatchGenerator
Choose from 1, 2, 3, 4, 5, 6, 7 [1]:
</code></pre>
<p>The generated model directory will contain a working implementation of a dataloader.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../03_Writing_dataloader.yaml/" class="btn btn-neutral float-right" title="dataloader.yaml">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../02_Writing_model.yaml/" class="btn btn-neutral" title="model.yaml"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="http://github.com/kipoi/kipoi/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../02_Writing_model.yaml/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../03_Writing_dataloader.yaml/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
